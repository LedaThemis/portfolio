---
import IraqMarshesLayout from "../../layouts/IraqMarshes/IraqMarshesLayout.astro";
---

<IraqMarshesLayout>
  <div class="flex flex-col items-center w-full grow py-4 relative">
    <!-- Header -->
    <div class="text-center mb-4 z-10">
      <h2 class="text-4xl font-bold mb-2">Preserve the Marshes</h2>
      <p class="text-lg text-gray-700 mb-2">Click anywhere to help preserve Iraq's precious marshlands!</p>
    </div>

    <!-- Counter Display - Fixed at top -->
    <div class="text-center mb-4 z-10">
      <div class="bg-white/90 backdrop-blur rounded-lg shadow-lg px-6 py-3 inline-block">
        <div class="text-4xl font-bold text-blue-600">
          <span id="counter">Loading...</span>
        </div>
        <div class="text-sm text-gray-600">Liters Preserved</div>
      </div>
    </div>

    <!-- Interactive Canvas Area -->
    <div id="marsh-canvas" class="relative w-full grow bg-gradient-to-b from-sky-200 to-green-100 rounded-lg overflow-hidden cursor-pointer shadow-xl">
      <!-- Water Level Background -->
      <div id="water-level" class="absolute bottom-0 left-0 w-full bg-gradient-to-t from-blue-400/60 to-blue-300/40 transition-all duration-1000 ease-out" style="height: 0%;">
        <!-- Fish swimming in the water -->
        <div id="water-fish" class="absolute inset-0 overflow-hidden pointer-events-none">
          <!-- Fish will be added here dynamically -->
        </div>
        
        <!-- Water waves animation -->
        <div class="absolute top-0 left-0 w-full h-8 overflow-hidden">
          <svg class="absolute w-full h-full" viewBox="0 0 1200 100" preserveAspectRatio="none">
            <path d="M0,50 Q150,30 300,50 T600,50 T900,50 T1200,50 L1200,100 L0,100 Z" fill="rgba(59, 130, 246, 0.3)">
              <animate attributeName="d" 
                dur="5s" 
                repeatCount="indefinite"
                values="
                  M0,50 Q150,30 300,50 T600,50 T900,50 T1200,50 L1200,100 L0,100 Z;
                  M0,50 Q150,70 300,50 T600,50 T900,50 T1200,50 L1200,100 L0,100 Z;
                  M0,50 Q150,30 300,50 T600,50 T900,50 T1200,50 L1200,100 L0,100 Z
                "/>
            </path>
          </svg>
        </div>
      </div>

      <!-- Reeds at the bottom -->
      <div id="marsh-reeds" class="absolute bottom-0 left-0 w-full pointer-events-none">
        <!-- Reeds will be added here dynamically -->
      </div>
      
      <!-- Objects will be spawned here -->
      <div class="absolute inset-0 flex items-center justify-center text-gray-400 text-lg pointer-events-none" id="instruction">
        <p class="bg-white/70 px-4 py-2 rounded-lg">üëÜ Click to add marsh elements</p>
      </div>
    </div>

    <!-- Success Message -->
    <div id="success-msg" class="hidden fixed bottom-8 left-1/2 transform -translate-x-1/2 z-50 px-6 py-3 bg-green-500 text-white rounded-lg shadow-lg animate-bounce">
      +1 Liter! üåä
    </div>

    <!-- Error Message -->
    <div id="error-msg" class="hidden fixed top-20 left-1/2 transform -translate-x-1/2 z-50 max-w-md">
      <div class="p-4 bg-red-100 text-red-800 rounded-lg shadow-lg text-center">
        <span id="error-text"></span>
      </div>
    </div>
  </div>
</IraqMarshesLayout>

<script>
  import { createClient } from '@supabase/supabase-js';

  // Initialize Supabase client
  const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL || '';
  const supabaseKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY || '';
  
  let supabase: any = null;
  let isSupabaseConfigured = false;

  if (supabaseUrl && supabaseKey) {
    supabase = createClient(supabaseUrl, supabaseKey);
    isSupabaseConfigured = true;
  }

  // DOM Elements
  const counterElement = document.getElementById('counter');
  const marshCanvas = document.getElementById('marsh-canvas');
  const waterLevel = document.getElementById('water-level');
  const waterFish = document.getElementById('water-fish');
  const marshReeds = document.getElementById('marsh-reeds');
  const successMsg = document.getElementById('success-msg');
  const errorMsg = document.getElementById('error-msg');
  const errorText = document.getElementById('error-text');
  const instruction = document.getElementById('instruction');

  let isThrottled = false;
  let currentCount = 0;
  let lastFishCount = 0;
  let lastReedCount = 0;

  // Function to add a permanent fish to the water
  function addFish() {
    if (!waterFish || !marshCanvas) return;
    
    const canvasWidth = marshCanvas.offsetWidth;
    const fishElement = document.createElement('div');
    
    const startX = Math.random() > 0.5 ? -50 : canvasWidth + 50;
    const yPos = 20 + Math.random() * 60; // Random depth in percentage
    const duration = 8 + Math.random() * 8; // 8-16 seconds
    const direction = startX < 0 ? 1 : -1;
    
    fishElement.className = 'absolute transition-none';
    fishElement.style.left = `${startX}px`;
    fishElement.style.top = `${yPos}%`;
    fishElement.style.transform = direction === 1 ? 'scaleX(-1)' : '';
    fishElement.innerHTML = `<img src="/assets/iraq-marshes/preserve-marshes/fish.png" alt="fish" class="w-16 h-auto opacity-80" />`;

    waterFish.appendChild(fishElement);

    // Animate fish swimming
    const endX = direction > 0 ? canvasWidth + 50 : -50;
    fishElement.style.transition = `left ${duration}s linear`;
    setTimeout(() => {
      fishElement.style.left = `${endX}px`;
    }, 50);

    // Remove fish after animation and add a new one
    setTimeout(() => {
      fishElement.remove();
      if (waterLevel && parseFloat(waterLevel.style.height) > 5) {
        addFish();
      }
    }, duration * 1000 + 100);
  }

  // Function to add a permanent reed
  function addReed() {
    if (!marshReeds || !marshCanvas) return;
    
    const canvasWidth = marshCanvas.offsetWidth;
    const xPos = Math.random() * canvasWidth;
    const height = 60 + Math.random() * 80; // 60-140px tall
    const sway = Math.random() * 3 + 2; // 2-5 seconds sway
    
    const reedElement = document.createElement('div');
    reedElement.className = 'absolute bottom-0';
    reedElement.style.left = `${xPos}px`;
    reedElement.style.transformOrigin = 'bottom center';
    reedElement.style.animation = `sway ${sway}s ease-in-out infinite`;
    reedElement.innerHTML = `<img src="/assets/iraq-marshes/preserve-marshes/grass.png" alt="reed" style="height: ${height}px; width: auto;" />`;

    marshReeds.appendChild(reedElement);
  }

  // Function to update water level based on count
  function updateWaterLevel(count: number) {
    if (!waterLevel) return;
    
    const oldCount = currentCount;
    currentCount = count;
    
    // Calculate water level percentage (e.g., 1 liter = 0.5%, cap at 100%)
    const percentage = Math.min((count * 1), 100);
    waterLevel.style.height = `${percentage}%`;
    
    // Change water color as it rises
    if (percentage > 75) {
      waterLevel.style.background = 'linear-gradient(to top, rgba(59, 130, 246, 0.8), rgba(96, 165, 250, 0.6))';
    } else if (percentage > 50) {
      waterLevel.style.background = 'linear-gradient(to top, rgba(59, 130, 246, 0.7), rgba(96, 165, 250, 0.5))';
    } else if (percentage > 25) {
      waterLevel.style.background = 'linear-gradient(to top, rgba(59, 130, 246, 0.6), rgba(96, 165, 250, 0.4))';
    }

    // Add fish as water level increases (1 fish per 10 liters)
    const fishToAdd = Math.floor(count / 10) - lastFishCount;
    for (let i = 0; i < fishToAdd; i++) {
      setTimeout(() => addFish(), i * 500);
    }
    lastFishCount = Math.floor(count / 10);

    // Add reeds as water level increases (1 reed per 5 liters)
    const reedsToAdd = Math.floor(count / 5) - lastReedCount;
    for (let i = 0; i < reedsToAdd; i++) {
      setTimeout(() => addReed(), i * 300);
    }
    lastReedCount = Math.floor(count / 5);
  }

  // Marsh objects definitions with images
  const marshObjects = [
    {
      name: 'reed',
      emoji: 'üåæ',
      image: '/assets/iraq-marshes/preserve-marshes/grass.png',
      class: 'w-12 h-auto'
    },
    {
      name: 'mudhif',
      emoji: 'üèõÔ∏è',
      image: '/assets/iraq-marshes/preserve-marshes/mudhif.png',
      class: 'w-20 h-auto'
    },
    {
      name: 'fish',
      emoji: 'üêü',
      image: '/assets/iraq-marshes/preserve-marshes/fish.png',
      class: 'w-16 h-auto'
    }
  ];

  // Function to get random marsh object
  function getRandomMarshObject() {
    return marshObjects[Math.floor(Math.random() * marshObjects.length)];
  }

  // Function to spawn object at position
  function spawnObject(x: number, y: number) {
    if (!marshCanvas) return;

    const obj = getRandomMarshObject();
    const objElement = document.createElement('div');
    
    objElement.className = 'absolute pointer-events-none transition-all duration-1000';
    objElement.style.left = `${x}px`;
    objElement.style.top = `${y}px`;
    objElement.style.transform = 'translate(-50%, -50%) scale(0)';
    objElement.style.opacity = '0';
    objElement.innerHTML = `<img src="${obj.image}" alt="${obj.name}" class="${obj.class}" />`;

    marshCanvas.appendChild(objElement);

    // Hide instruction after first click
    if (instruction) {
      instruction.style.display = 'none';
    }

    // Animate in
    setTimeout(() => {
      objElement.style.transform = 'translate(-50%, -50%) scale(1)';
      objElement.style.opacity = '1';
    }, 10);

    // Animate out and remove after 3 seconds
    setTimeout(() => {
      objElement.style.transform = 'translate(-50%, -50%) scale(0) rotate(360deg)';
      objElement.style.opacity = '0';
      setTimeout(() => {
        objElement.remove();
      }, 1000);
    }, 2000);
  }

  // Function to fetch current counter value
  async function fetchCounter() {
    if (!isSupabaseConfigured) {
      if (counterElement) {
        counterElement.textContent = '0';
      }
      return;
    }

    try {
      const { data, error } = await supabase
        .from('marsh_counter')
        .select('count')
        .single();

      if (error) {
        console.error('Error fetching counter:', error);
        if (counterElement) {
          counterElement.textContent = '0';
        }
        updateWaterLevel(0);
      } else {
        const count = data?.count || 0;
        if (counterElement) {
          counterElement.textContent = count.toLocaleString();
        }
        updateWaterLevel(count);
      }
    } catch (err) {
      console.error('Error:', err);
      if (counterElement) {
        counterElement.textContent = '0';
      }
      updateWaterLevel(0);
    }
  }

  // Function to increment counter
  async function incrementCounter() {
    if (!isSupabaseConfigured) {
      showError('Supabase is not configured.');
      return;
    }

    if (isThrottled) return;
    isThrottled = true;

    try {
      const { data, error } = await supabase.rpc('increment_marsh_counter');

      if (error) {
        console.error('Error incrementing counter:', error);
        showError('Failed to contribute.');
      } else {
        // If data is null, fetch the current count from the table
        if (data === null || data === undefined) {
          const { data: fetchData, error: fetchError } = await supabase
            .from('marsh_counter')
            .select('count')
            .single();
          
          if (!fetchError && fetchData) {
            const count = fetchData.count || 0;
            if (counterElement) {
              counterElement.textContent = count.toLocaleString();
            }
            updateWaterLevel(count);
          }
        } else {
          if (counterElement) {
            counterElement.textContent = (data || 0).toLocaleString();
          }
          updateWaterLevel(data || 0);
        }
        
        // Show success message
        if (successMsg) {
          successMsg.classList.remove('hidden');
          setTimeout(() => {
            successMsg.classList.add('hidden');
          }, 1500);
        }
      }
    } catch (err) {
      console.error('Unexpected error:', err);
      showError('An error occurred.');
    } finally {
      // Throttle for 500ms
      setTimeout(() => {
        isThrottled = false;
      }, 500);
    }
  }

  // Function to show error message
  function showError(message: string) {
    if (errorText) errorText.textContent = message;
    if (errorMsg) {
      errorMsg.classList.remove('hidden');
      setTimeout(() => {
        errorMsg.classList.add('hidden');
      }, 3000);
    }
  }

  // Event listener for canvas clicks
  if (marshCanvas) {
    marshCanvas.addEventListener('click', (e: MouseEvent) => {
      const rect = marshCanvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      
      spawnObject(x, y);
      incrementCounter();
    });
  }

  // Subscribe to real-time updates
  if (isSupabaseConfigured && supabase) {
    supabase
      .channel('marsh_counter_changes')
      .on('postgres_changes', 
        { event: '*', schema: 'public', table: 'marsh_counter' }, 
        (payload: any) => {
          if (payload.new?.count !== undefined) {
            const count = payload.new.count;
            if (counterElement) {
              counterElement.textContent = count.toLocaleString();
            }
            updateWaterLevel(count);
          }
        }
      )
      .subscribe();
  }

  // Initial fetch
  fetchCounter();
</script>

<style>
  #marsh-canvas {
    min-height: 400px;
    background-image: 
      radial-gradient(circle at 20% 80%, rgba(34, 139, 34, 0.1) 0%, transparent 50%),
      radial-gradient(circle at 80% 60%, rgba(70, 130, 180, 0.1) 0%, transparent 50%);
  }
  
  @keyframes float {
    0%, 100% { transform: translateY(0px); }
    50% { transform: translateY(-10px); }
  }

  @keyframes sway {
    0%, 100% { transform: rotate(-2deg); }
    50% { transform: rotate(2deg); }
  }
</style>
